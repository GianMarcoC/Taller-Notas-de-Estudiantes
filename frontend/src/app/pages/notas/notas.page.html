<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home" text="Inicio"></ion-back-button>
    </ion-buttons>
    <ion-title>Gestión de Calificaciones</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Información del profesor -->
  <ion-card color="light" class="info-card">
    <ion-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="8">
            <strong>Profesor:</strong> {{user?.nombre}}<br />
            <strong>Rol:</strong> {{user?.role | uppercase}}
          </ion-col>
          <ion-col size="4" class="ion-text-end">
            <ion-badge color="primary"
              >{{getTotalRegistros()}} calificaciones</ion-badge
            >
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <!-- Filtros y Estadísticas -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Filtros y Estadísticas</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="12" size-md="6">
            <ion-item>
              <ion-label position="stacked">Filtrar por Asignatura</ion-label>
              <ion-select
                [(ngModel)]="asignaturaFiltro"
                (ionChange)="filtrarNotas()"
                interface="action-sheet"
              >
                <ion-select-option value="">Todas las asignaturas</ion-select-option>
                <ion-select-option
                  *ngFor="let curso of cursos"
                  [value]="curso.nombre"
                >
                  {{curso.nombre}}
                </ion-select-option>
              </ion-select>
            </ion-item>
          </ion-col>
          <ion-col size="12" size-md="6">
            <ion-grid>
              <ion-row>
                <ion-col size="6">
                  <div class="stat-card">
                    <ion-text color="primary">
                      <div class="stat-value">{{calcularPromedio()}}</div>
                      <div class="stat-label">Promedio</div>
                    </ion-text>
                  </div>
                </ion-col>
                <ion-col size="6">
                  <div class="stat-card">
                    <ion-text color="success">
                      <div class="stat-value">{{contarNotasAltas()}}</div>
                      <div class="stat-label">Notas ≥ 4.0</div>
                    </ion-text>
                  </div>
                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <!-- Botón para agregar nota (SOLO UN BOTÓN) -->
  <ion-card>
    <ion-card-content class="ion-text-center">
      <ion-button (click)="agregarNota()" expand="block" fill="solid" color="success">
        <ion-icon slot="start" name="add-circle"></ion-icon>
        Nueva Calificación
      </ion-button>
    </ion-card-content>
  </ion-card>

  <!-- Lista de calificaciones -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Registro de Calificaciones</ion-card-title>
      <ion-card-subtitle
        >Desliza hacia la izquierda para ver opciones</ion-card-subtitle
      >
    </ion-card-header>
    <ion-card-content class="ion-no-padding">
      <ion-list lines="full">
        <ion-item-sliding
          *ngFor="let nota of notasFiltradas; trackBy: trackByNotaId"
        >
          <!-- CONTENIDO VISIBLE -->
          <ion-item detail="false" class="grade-item">
            <ion-avatar slot="start" class="student-avatar">
              <div
                class="avatar-content"
                [ngClass]="getNotaColor(nota.calificacion)"
              >
                {{nota.calificacion}}
              </div>
            </ion-avatar>

            <ion-label class="nota-info">
              <h2>{{nota.estudianteNombre || 'Estudiante ' + nota.estudiante_id}}</h2>
              <p>
                <ion-icon name="book" size="small"></ion-icon>
                {{nota.asignatura}}
              </p>
              <p>
                <ion-icon name="calendar" size="small"></ion-icon>
                Periodo: {{nota.periodo}}
              </p>
              <p>
                <ion-icon name="time" size="small"></ion-icon>
                {{formatearFecha(nota.fecha)}}
              </p>
              <p *ngIf="nota.observaciones" class="observaciones">
                <ion-icon name="chatbubble" size="small"></ion-icon>
                {{nota.observaciones}}
              </p>
            </ion-label>

            <div slot="end" class="nota-badge">
              <ion-badge
                [color]="getNotaColor(nota.calificacion)"
                class="calificacion-badge"
              >
                {{nota.calificacion}}
              </ion-badge>
              <div class="nota-texto">{{getNotaTexto(nota.calificacion)}}</div>
            </div>
          </ion-item>

          <!-- BOTONES DE ACCIÓN - DESLIZAR -->
          <ion-item-options side="end">
            <ion-item-option color="primary" (click)="editarNota(nota)">
              <ion-icon name="create" slot="start"></ion-icon>
              Editar
            </ion-item-option>
            <ion-item-option color="danger" (click)="eliminarNota(nota)">
              <ion-icon name="trash" slot="start"></ion-icon>
              Eliminar
            </ion-item-option>
          </ion-item-options>
        </ion-item-sliding>
      </ion-list>

      <!-- Mensaje cuando no hay notas -->
      <div
        *ngIf="notasFiltradas.length === 0"
        class="empty-state ion-text-center ion-padding"
      >
        <ion-icon
          name="document-outline"
          size="large"
          color="medium"
        ></ion-icon>
        <h3>No hay calificaciones registradas</h3>
        <p>Comience agregando la primera calificación</p>
        <ion-button (click)="agregarNota()" color="primary" size="default">
          <ion-icon slot="start" name="add"></ion-icon>
          Registrar Calificación
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>
</ion-content>